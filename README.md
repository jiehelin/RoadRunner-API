# RoadRunner-API
How to use RoadRunner API in python 

## Import and export scenes using MATLAB® functions or a gRPC® API

RoadRunner provides programmatic interfaces for performing common workflow tasks such as opening, closing, and saving scenes and projects and importing and exporting scenes.

## 1.准备项：

Your locally installed version of RoadRunner is the server application.

The RoadRunner API provides the RPC methods used to remotely control RoadRunner.

The programs you write to call the RPC methods are the client applications. The gRPC framework is language-neutral and platform-neutral. You can write clients that call the RoadRunner API in any platform and language that gRPC supports. For details on what languages and platforms gRPC supports, see the [gRPC Documentation](https://grpc.io/docs/).

##  2.在roadrunner中找到准备编译的gRPC文件描述api接口和功能

file path：C:\Program Files\RoadRunner R2023a\bin\win64\Proto

将里面所有的文件都复制出来（在文件内部结构无法编译和加入代码文件）

新建一个新的文件目录，可以是任何位置，比如桌面

将原安装目录中的matworks复制过来，整个文件夹都复制过来

例如：C:\Users\admin\Desktop\RoadRunner_API

在C:\Users\admin\Desktop\RoadRunner_API  vscode打开，在根目录下新建py文件。以下代码可以逐层找到proto文件并编译成py的api接口

pathToClient 是在此路径中的子文件夹找到全部的proto文件接口

pathToProtos 生成的py接口文件保存位置

```python
import os
import subprocess

pathToClient = r"C:\Users\admin\Desktop\RoadRunner_API"
pathToProtos = r"C:\Users\admin\Desktop\RoadRunner_API"

# Get list of all protobuf files
protoFiles = list()
for root, dirs, files in os.walk(pathToProtos):
    for file in files:
        if file.endswith(".proto"):
            protoFiles.append(os.path.join(root,file))

# Generate protobuf compiler command
command = ('python -m grpc.tools.protoc --proto_path="' + pathToProtos + \
'" --python_out="' + pathToClient + '" --grpc_python_out="' + pathToClient + '"')
 
for file in protoFiles:
    command += ' "' + file + '"'
 
print("Compiling protobuf files...")
print("Executing command:\n\n" + command + "\n")
 
out = subprocess.run(command, check=True)
 
print("Successfully compiled protobuf files. Generated Python files are located in '"
+ pathToClient + "'")
```

编译后的py文件，例如：roadrunner_service.proto -> roadrunner_service_pb2_grpc.py

```python
# Generated by the gRPC Python protocol compiler plugin. DO NOT EDIT!
"""Client and server classes corresponding to protobuf-defined services."""
import grpc
import warnings

from mathworks.roadrunner import roadrunner_service_messages_pb2 as mathworks_dot_roadrunner_dot_roadrunner__service__messages__pb2

GRPC_GENERATED_VERSION = '1.67.1'
GRPC_VERSION = grpc.__version__
_version_not_supported = False

try:
    from grpc._utilities import first_version_is_lower
    _version_not_supported = first_version_is_lower(GRPC_VERSION, GRPC_GENERATED_VERSION)
except ImportError:
    _version_not_supported = True

if _version_not_supported:
    raise RuntimeError(
        f'The grpc package installed is at version {GRPC_VERSION},'
        + f' but the generated code in mathworks/roadrunner/roadrunner_service_pb2_grpc.py depends on'
        + f' grpcio>={GRPC_GENERATED_VERSION}.'
        + f' Please upgrade your grpc module to grpcio>={GRPC_GENERATED_VERSION}'
        + f' or downgrade your generated code using grpcio-tools<={GRPC_VERSION}.'
    )


class RoadRunnerServiceStub(object):
    """Service for the RoadRunner methods (type definitions are in roadrunner_service_messages.proto)
    ////////////////////////////////////
    Project Methods
    ////////////////////////////////////
    """

    def __init__(self, channel):
        """Constructor.

        Args:
            channel: A grpc.Channel.
        """
        self.NewProject = channel.unary_unary(
                '/mathworks.roadrunner.RoadRunnerService/NewProject',
                request_serializer=mathworks_dot_roadrunner_dot_roadrunner__service__messages__pb2.NewProjectRequest.SerializeToString,
                response_deserializer=mathworks_dot_roadrunner_dot_roadrunner__service__messages__pb2.NewProjectResponse.FromString,
                _registered_method=True)
        self.LoadProject = channel.unary_unary(
                '/mathworks.roadrunner.RoadRunnerService/LoadProject',
                request_serializer=mathworks_dot_roadrunner_dot_roadrunner__service__messages__pb2.LoadProjectRequest.SerializeToString,
                response_deserializer=mathworks_dot_roadrunner_dot_roadrunner__service__messages__pb2.LoadProjectResponse.FromString,
                _registered_method=True)
        self.SaveProject = channel.unary_unary(
                '/mathworks.roadrunner.RoadRunnerService/SaveProject',
                request_serializer=mathworks_dot_roadrunner_dot_roadrunner__service__messages__pb2.SaveProjectRequest.SerializeToString,
                response_deserializer=mathworks_dot_roadrunner_dot_roadrunner__service__messages__pb2.SaveProjectResponse.FromString,
                _registered_method=True)
        self.NewScene = channel.unary_unary(
                '/mathworks.roadrunner.RoadRunnerService/NewScene',
                request_serializer=mathworks_dot_roadrunner_dot_roadrunner__service__messages__pb2.NewSceneRequest.SerializeToString,
                response_deserializer=mathworks_dot_roadrunner_dot_roadrunner__service__messages__pb2.NewSceneResponse.FromString,
                _registered_method=True)
```

可以看到其中有很多功能。

用命令启动Roadrunner 

C:\RR\MyProject  roadrunner 工程文件夹

```bash
cd "C:\Program Files\RoadRunner R2024b\bin\win64"
AppRoadRunner --projectPath C:\RR\MyProject --apiPort 54321
```

python向端口发东西，在roadrunner中load 名字是FourWaySignal的场景文件

```python
import grpc
from mathworks.roadrunner import roadrunner_service_messages_pb2
from mathworks.roadrunner import roadrunner_service_pb2_grpc

with grpc.insecure_channel("localhost:54321") as channel:
    api = roadrunner_service_pb2_grpc.RoadRunnerServiceStub(channel)
    loadSceneRequest = roadrunner_service_messages_pb2.LoadSceneRequest()
    loadSceneRequest.file_path = "FourWaySignal"
    api.LoadScene(loadSceneRequest)
```

还可以load  opendrive文件

```python
import grpc
from mathworks.roadrunner import roadrunner_service_pb2
from mathworks.roadrunner import roadrunner_service_pb2_grpc
from mathworks.roadrunner import roadrunner_service_messages_pb2

# 打开与 RoadRunner 服务的连接
with grpc.insecure_channel("localhost:54321") as channel:
    api = roadrunner_service_pb2_grpc.RoadRunnerServiceStub(channel)

    # 创建导入 OpenDRIVE 文件的请求
    importRequest = roadrunner_service_messages_pb2.ImportRequest()
    importRequest.file_path = r"C:\Software\RoadRunner\Assets\opendrive\asda.xodr"
    importRequest.format_name = "OpenDRIVE"
    importRequest.open_drive_settings.import_signals.value = False
    api.Import(importRequest)
```

目前不支持使用接口的方式去创建道路，选择材质等，只支持导入导出不同的格式，比如模型资产，道路结构。可与其他仿真器做配合比如carla，carmaker等，模型可完美兼容虚幻4和unigine引擎渲染。

仓库中有已经编译好的proto文件和使用方式。更多信息在mathwork help中

